name: Deploy Portfolio

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Wait for Tailscale
        run: sleep 5

      - name: Check connectivity
        run: |
          tailscale status
          ping -c 3 100.103.96.121
          timeout 5 bash -c "</dev/tcp/100.103.96.121/22" && echo "SSH port open"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            cd /var/www/portfolio
            git fetch origin
            git reset --hard origin/main

